<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>AI Hand Security</title>

<style>
body{margin:0;background:black;color:#0f0;font-family:monospace}
video,canvas{position:absolute;top:0;left:0;width:100vw;height:100vh;object-fit:cover}
#ui{
  position:fixed;
  bottom:15px;left:50%;
  transform:translateX(-50%);
  background:#000c;
  border:1px solid #0f0;
  padding:10px;
}
button{
  background:black;color:#0f0;
  border:1px solid #0f0;
  padding:8px;margin:5px
}
</style>
</head>

<body>

<video id="video" autoplay playsinline></video>
<canvas id="canvas"></canvas>

<div id="ui">
  <button onclick="switchCam()">GANTI KAMERA</button>
  <button onclick="lockMode=true">LOCK OBJEK</button>
  <div id="info">Status: Monitoring</div>
</div>

<audio id="alarm" src="alarm.mp3"></audio>

<script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>

<script>
const video=document.getElementById("video")
const canvas=document.getElementById("canvas")
const ctx=canvas.getContext("2d")
const alarm=document.getElementById("alarm")
let camFacing="environment" // default belakang
let lockMode=false,locked=null,alarmOn=false

function resize(){
  canvas.width=video.videoWidth
  canvas.height=video.videoHeight
}
window.onresize=resize

async function startCam(){
  if(window.stream){
    window.stream.getTracks().forEach(t=>t.stop())
  }
  const stream=await navigator.mediaDevices.getUserMedia({
    video:{facingMode:camFacing}
  })
  window.stream=stream
  video.srcObject=stream
  video.onloadedmetadata=resize
}
startCam()

function switchCam(){
  camFacing = camFacing==="user" ? "environment" : "user"
  startCam()
}

// HANDS
const hands=new Hands({
  locateFile:f=>`https://cdn.jsdelivr.net/npm/@mediapipe/hands/${f}`
})
hands.setOptions({
  maxNumHands:1,
  modelComplexity:1,
  minDetectionConfidence:0.6,
  minTrackingConfidence:0.6
})
hands.onResults(draw)

const cam=new Camera(video,{
  onFrame:async()=>{await hands.send({image:video})},
  width:640,height:480
})
cam.start()

canvas.onclick=e=>{
  if(!lockMode) return
  const r=canvas.getBoundingClientRect()
  locked={
    x:e.clientX-r.left-50,
    y:e.clientY-r.top-50,
    w:100,h:100,
    ox:e.clientX-r.left-50,
    oy:e.clientY-r.top-50
  }
  lockMode=false
  info.innerText="Objek terkunci"
}

function draw(res){
  ctx.clearRect(0,0,canvas.width,canvas.height)
  ctx.drawImage(res.image,0,0,canvas.width,canvas.height)

  let handTouch=false

  if(res.multiHandLandmarks){
    res.multiHandLandmarks.forEach(hand=>{
      ctx.strokeStyle="#00ff00"
      ctx.lineWidth=2
      hand.forEach(p=>{
        ctx.beginPath()
        ctx.arc(p.x*canvas.width,p.y*canvas.height,5,0,6.28)
        ctx.stroke()
      })

      if(locked){
        const hx=hand[8].x*canvas.width
        const hy=hand[8].y*canvas.height
        if(hx>locked.x&&hx<locked.x+locked.w&&hy>locked.y&&hy<locked.y+locked.h){
          handTouch=true
        }
      }
    })
  }

  if(locked){
    ctx.strokeStyle="red"
    ctx.lineWidth=3
    ctx.strokeRect(locked.x,locked.y,locked.w,locked.h)

    if(handTouch) locked.x+=2

    const moved=Math.abs(locked.x-locked.ox)>30
    if(moved&&!alarmOn){
      alarmOn=true
      alarm.play()
      alert("⚠️ Barang Anda telah dicuri!")
    }
  }
}
</script>
</body>
</html>
